<html>

<input id="message"></input>
<button id="sub">Send</button>
<ul id="resp"></ul>

<script src="client/js/SocketDispatcher.js"></script>

<script>
    if (!window.WebSocket) { 
        alert("No websockets :(");
        return;
    }

    // Assume modern browser, needs websockets anyway
    var m = document.getElementById("message"),
        s = document.getElementById("sub"),
        r = document.getElementById("resp");

    var server = new SocketDispatcher("ws://localhost:8989/suggest/");
    
    s.onclick = function() {
        server.send('partial', m.value);
    };

    m.addEventListener("keyup", function() {
        // Cheap optimization - small values (ie. "1") are expensive to search for
        if (m.value.length > 3) {
            server.send('partial', m.value);  
        } else {
            r.innerHTML = "";
        }
    });

    server.on('multiple', function(results) {
            r.innerHTML = "";
            var suggestions = JSON.parse(results);
            if (!suggestions) return;
            suggestions.forEach(createSingleSuggestion)
        })
        .on('single', jsonParse(createSingleSuggestion))  
        .on('close', function(e) {
            console.warn("Socket Closed");
        })
        .on('error', function(){
            console.error("Socket Error!");
        });

    function createSingleSuggestion(suggest) {
        var li = document.createElement("li");
        li.textContent = suggest.Full;
        r.appendChild(li);        
    }

    function jsonParse(fn) {
        return function(result) {
            fn(JSON.parse(result));
        };
    }

</script>

</html>